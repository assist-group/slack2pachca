# И всё заверте ...

Сначала был Слак.  
А потом казалось,  что импортозамещение да, но это не про нас.  
Небось успеем еще.  
А потом был авось.  
А потом таки клюнул тот самый жареный петух и...

Это был приквел.  
И это совершенно другая история.  
И однажды ее расскажут совсем другие люди.  
Если захотят.

## Переезжаем!

Все решения приняты, все лыжи смазаны, все срочно-припадочно, всё еще вчера, всё как мы любим.

Пользователи предупреждены,  
потом строго предупреждены,  
потом предупреждены строго-настрого,  
потом предупреждены в последний раз,  
потом предупреждены в самый последний раз!...  
Нувыпонели.

Предупреждены о чем?

### Дампы

Штатные дампы дампятся, но они не решают проблему.  
Вернее решают, но не целиком и не совсем (совсем не) так, как хочется.  
Они дампят только публичные каналы.  
Чтобы сдампить что-то сверх того заюзаны сторонние слак-дамперы, которые умеют дампить все то, к чему имеет доступ юзер с соответствующим логином.  
И это уже кое-что.

Пользователи предупреждены о том, что если им хочется сохранить инфу, размещенную в своих каналах, они должны

- либо в свои приватные каналы добавить спец-юзера
- либо сделать свои каналы публичными

(И что вы думаете? Некоторые так ничего и не осознали, вплоть до дня окончательного переезда в Пачку!)

Кто не спрятался мы не виноваты.  
Поехали!

### Пачка!

Почему Пачка а не...?  
У каждого из вас будет свой ответ на этот простой вопрос.  
Наш список вариантов переезда состоял не из одного пункта  
И мы свой выбор сделали.  
Желаем и вам выбрать ту самую, единственную,  
самую лучшую  
компанию которая будет стараться сделать для вас всё  
и даже больше.

Удачи!

### API

Если вы вдруг не знали - У Пачки есть API.  
Не скажу, что его возможностей нам было достаточно, но мы сумели обойтись тем что есть.

(Пачка предлагает штатную услугу по переезду из Слак.  
К сожалению, не наш вариант.  
Мы должны были учитывать свою специфику.  
В частности, не все каналы и не все документы можно было переносить "как есть", не вникая)

Чего не хватало (и не хватает)(и временами позарез):

- возможности совершать операции (создавать каналы, сообщения, реакции) от лица определенного пользователя  
  (к слову, реакции мы так и не перенесли.  
  Невелика потеря, но осадочек, как говорится, остался)
- назначать владельца каналов
- назначать каналу статус "архивный"
- удалять каналы и сообщения
  (при переносе косяков не избежать, и вы не представляете себе, насколько была бы проще жизнь, если бы API предоставляло бы эти возможности!)

Не смотря на все эти трудности мы справились!  
(Кто молодец?)

(На полях заметим, что API Пачки стремительно развивается, и все что здесь написано на момент публикации может быть уже не актуальным. Например, возможность удалять сообщения появилась уже в августе этого (2024) года.)

### Как это было?

#### Выбор платформы

Не то чтобы мы очень уж задавались этим вопросом.
Сразу решили что это будет Java, Spring, Spring Shell + Spring RestClient
Мы это любим, умеем, практикуем.
И если это решает проблему то почему нет?

Для начала нам нужно что? Правильно, модель!

#### Модель

Здесь особо нечего рассказывать.
Мы посмотрели официальную документацию Пачки по API и для каждого запроса запилили соответствующие POJO.

А затем мы написали клиентов

#### Сервисы

В основном это CRUD + List
Каждый метод завернут в spring-retry, мало ли что.
(И практика показала, что не напрасно.
Довольно часто приходит отлуп по 429 (ну конечно, мы же стараемся пропихнуть как можно больше запросов, мы торопимся, нам всё нужно было еще вчера!), бывают и другие сетевые неприятности)

#### Анализ дампов

Теперь нам нужна модель данных слак-дампов.
Это пользователи - users.json
Каналы - channels.json
Сообщения - каждый дамп лежит в папке с именем, соответствующим названию канала и представляет собой json файл с именем, соответствующим дате списка сообщений.
Если вы ничего не поняли это нормально, лучше один раз увидеть!


#### Модель данных слак-дампа

Чтобы загрузить данные из дампа нам нужны соответствующие POJO.
И мы их сделали!
Не будем утомлять подробностями.
Скажем только, что в загрузке данных нам помогала известная всем нам  ~~с детства~~ библиотека jackson

#### Сливаем в экстазе

Итак.
Мы научились загружать данные из дампов.
Юзать API Пачки.
Казалось бы, всё есть!
Но все же чего-то не хватает....
Хмммм...
Форматы сообщений Слака и Пачки не совпадают!
~~Кто бы мог подумать...~~
Значит придумываем преобразователь из одного в другое.
И это самая творческая часть процесса, поскольку (повторюсь) прямых соответствий нет.

#### Хороший

Всё получилось, мы переехали.
Наш одноразовый код прекрасно справился с задачей!
Не смотря на некоторое количество нюансов

#### Плохой

Не всё получилось так, как хотелось бы

Во-первых, не всегда было понятно что и как будет выглядеть в итоге.
Поэтому мы сделали фиксилку сообщений.

Во-вторых, мы доливали файлы аттачментов, поскольку там были свои трудности и кое-что было потеряно (спокойно, не навсегда!).
Так у нас появилась фиксилка для аттачей.

В-третьих, при внешней схожести форматов данных штатного и альтернативного дампа (что нас обрадовало) было обнаружено (сразу незамеченное нами) несходство в части описания комментариев к сообщениям.
Что привело к их потере при импорте сообщений из альтернативных дампов.
Так у нас появилась фиксилка для комментов.

#### Злой

Поскольку все операции производилиь по токену (т.е. фактически от лица определенного пользователя) он и стал владельцем всех каналов.
И тут самое время обратиться (в очередной раз ) с просьбой:

Дорогая Пачка!
Будь так любезна, добавь в АПИ все то, что может делать пользователь руками!
Мы очень-очень-преочень хотим менять владельца канала(беседы) через АПИ!
Да, мы можем это делать руками, но 700 каналов?!
Это перебор.
Вся наша (высоко)технологичная душа протестует против ручного монотонного труда в таких количествах!

Ровно то же самое хотелось бы сказать и об архивах.
Хотелось бы отправлять каналы в архив программным, а не ручным способом.

#### (Никому не) нужные (не) технические подробности

В силу приоритета "быстро" над всеми остальными приоритетами мы срезали острые углы везде, где это было возможно.  
Поэтому - только код. Человекочитаемый, простой.  
Но - нет комментов. Совсем.  
Бедненько. Но чистенько.  
Без особых изысков, в стиле японского минимализма.  
Сумимасэн!

Нумерация версий.
До первой большой цифры, которая до точки,  мы так и не доросли.  
Вторая цифра увеличивалась на единичку всякий раз, когда появлялась новая, ранее не виданная фича.  
Третья цифра - багфикс или небольшая доработка

### Краткое Итого

Код - [здесь](https://).
Вопросы задавать - [сюда](https://).
Пачка - [там](https://).

Спасибо за внимание!
