# Pachca webhook

## Описание

Эта статья описывает способ интеграции Zabbix 6.0 c Pachca используя функционал Zabbix webhook. Приводится инструкция по настройке media type, пользователя и действий (Trigger action) в Zabbix.

## Требования

Zabbix version: 6.0 или выше.

## Параметры

После импорта данного webhook вы должны настроить следующие параметры:

|Name|Value|Description|
|----|-----|-----------|
|zabbix_url|\{$ZABBIX\.URL\}|Current Zabbix URL.|
|bot_token|\<PLACE YOUR TOKEN\>|Pachca bot token.|
|bot_user_id|\<PLACE BOT USER ID\>|Pachca bot user_id.|
|pachca_mode|alarm|Working mode. Could be "alarm" or "event" as a value.|

## Настройка bot в Pachca

1\. Перейдите в раздел *Автоматизации* -> *Интеграции*.

2\. Найдите в списке раздел *Чат-боты и Вебхуки* -> *Настройки*

3\. Нажмите на иконку `+` -> выберите *Для нескольких чатов*.

4\. Cкопируйте `user_id` и `access_token` из вкладки *API*.

## Настройка Zabbix

1\. Убедитесь что в Zabbix настроен глобальный макрос **{$ZABBIX.URL}**, который должен содержать **URL** к Zabbix frontend.

2\. В интерфейсе Zabbix *Alerts* > *Media types* импортируйте [`media_pachca.yaml`](media_pachca.yaml) file.

3\. Откройте вновь созданный **Pachca** media type и установите в качестве значения параметра `bot_token` `acces_token` полученный в Pachca.

4\. В параметре `bot_user_id` установите содержимое значения `user_id` полученный в Pachca.

* Также вы можете выбрать между двумя режимами работы:
	- **alarm** (default)
		- Сообщения о обновлении будут приходить в тред к оригинальному сообщению. Сообщения о восстановлении будут обновлять оригинальное сообщение.
	- **event**
		- Сообщения о обновлении и восстановлении от Zabbix будут приходить в виде новых сообщений.

4\. Нажмите на кнопку **Update** для сохранения настроек **Webhook**.

5\. Для получения нотификаций в **Pachca**, вам необходимо создать пользователя в **Zabbix** и добавить для него **Media** c типом **Pachca**.

Поле **Send to** должно содержать цифровой идентификатор канала в Pachca. Для того чтобы его получить вы можете нажать на иконку с трёмя точками справа вверху в канале. Выбрать меню *Скопировать ссылку*. Вставить её в блокнот или любой текстовый редактор. В конце ссылки будет содержаться цифровой идентификатор канала.

6\. Добавьте бота в нужный вам канал.